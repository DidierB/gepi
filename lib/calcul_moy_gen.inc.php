<?php/* * $Id$ * * Copyright 2001, 2005 Thomas Belliard, Laurent Delineau, Edouard Hue, Eric Lebrun* Portion de code qui calcule des tableaux suivants$moy_gen_classe =  tableau des moyennes générales de la classe$moy_gen_eleve =  tableau des moyennes générales d'élèvesle script à besoin de : - $id_classe : la classe concernée - $periode_num : la période concernée*/$quartile1_classe_gen = 0;$quartile2_classe_gen = 0;$quartile3_classe_gen = 0;$quartile4_classe_gen = 0;$quartile5_classe_gen = 0;$quartile6_classe_gen = 0;// On appelle la liste des élèves de la classe$appel_liste_eleves = mysql_query("SELECT e.* FROM eleves e, j_eleves_classes c    WHERE (    e.login = c.login and    c.id_classe = '".$id_classe."' and    c.periode='".$periode_num."'    )    ORDER BY e.nom, e.prenom");    $nombre_eleves = mysql_num_rows($appel_liste_eleves);// On appelle la liste des matière de la classeif ($affiche_categories) {		// On utilise les valeurs spécifiées pour la classe en question		$appel_liste_groupes = mysql_query("SELECT DISTINCT jgc.id_groupe, jgc.coef, jgc.categorie_id ".		"FROM j_groupes_classes jgc, j_groupes_matieres jgm, j_matieres_categories_classes jmcc, matieres m " .		"WHERE ( " .		"jgc.categorie_id = jmcc.categorie_id AND " .		"jgc.id_classe='".$id_classe."' AND " .		"jgm.id_groupe=jgc.id_groupe AND " .		"m.matiere = jgm.id_matiere" .		") " .		"ORDER BY jmcc.priority,jgc.priorite,m.nom_complet");} else {	$appel_liste_groupes = mysql_query("SELECT DISTINCT jgc.id_groupe, jgc.coef	FROM j_groupes_classes jgc, j_groupes_matieres jgm	WHERE (	jgc.id_classe='".$id_classe."' AND	jgm.id_groupe=jgc.id_groupe	)	ORDER BY jgc.priorite,jgm.id_matiere");}$nombre_groupes = mysql_num_rows($appel_liste_groupes);// Initialisation des tableaux liés aux calculs des moyennes générales$current_group = array();$current_coef = array();$moy_gen_classe = array();$moy_gen_eleve = array();$moy_cat_eleve = array();$moy_cat_classe = array();$total_coef = array();$total_coef_cat = array();$i=0;$get_cat = mysql_query("SELECT id FROM matieres_categories");$categories = array();while ($row = mysql_fetch_array($get_cat, MYSQL_ASSOC)) {  	$categories[] = $row["id"];}while ($i < $nombre_eleves) {    $total_coef[$i] = 0;    $moy_gen_eleve[$i] = 0;    $moy_gen_classe[$i] = 0;    $moy_cat_classe[$i] = array();    $moy_cat_eleve[$i] = array();    $total_coef_cat[$i] = array();	foreach($categories as $cat_id) {    	$moy_cat_eleve[$i][$cat_id] = 0;    	$total_coef_cat[$i][$cat_id] = 0;    	$moy_cat_classe[$i][$cat_id] = 0;    }    $i++;}// Préparation des données$j=0;$prev_cat = null;while ($j < $nombre_groupes) {    $group_id = mysql_result($appel_liste_groupes, $j, "id_groupe");    $current_group[$j] = get_group($group_id);	$current_coef[$j] = mysql_result($appel_liste_groupes, $j, "coef");	if(isset($coefficients_a_1)){		if($coefficients_a_1=="oui"){			$current_coef[$j]=1;		}	}    if ($current_group[$j]["classes"]["classes"][$id_classe]["categorie_id"] != $prev_cat) {    	$prev_cat = $current_group[$j]["classes"]["classes"][$id_classe]["categorie_id"];    }    // Moyenne de la classe dans la matière $current_matiere[$j]    $current_classe_matiere_moyenne_query = mysql_query("SELECT round(avg(note),1) moyenne        FROM matieres_notes        WHERE (        statut ='' AND        id_groupe='".$current_group[$j]["id"]."' AND        periode='$periode_num'        )        ");    $current_classe_matiere_moyenne[$j] = mysql_result($current_classe_matiere_moyenne_query, 0, "moyenne");    // Calcul de la moyenne des élèves et de la moyenne de la classe    $i=0;    while ($i < $nombre_eleves) {        $current_eleve_login[$i] = mysql_result($appel_liste_eleves, $i, "login");        // Maintenant on regarde si l'élève suit bien cette matière ou pas        if (in_array($current_eleve_login[$i], $current_group[$j]["eleves"][$periode_num]["list"])) {        	//$count[$j][$i] == "0"            $current_eleve_note_query = mysql_query("SELECT distinct * FROM matieres_notes            WHERE (            login='".$current_eleve_login[$i]."' AND            periode='$periode_num' AND            id_groupe='".$current_group[$j]["id"]."'            )");            $current_eleve_note[$j][$i] = @mysql_result($current_eleve_note_query, 0, "note");            $current_eleve_statut[$j][$i] = @mysql_result($current_eleve_note_query, 0, "statut");            if ($current_coef[$j] != 0) {               if (($current_eleve_note[$j][$i] != '') and ($current_eleve_statut[$j][$i] == '')) {                    $total_coef[$i] += $current_coef[$j];                    $total_coef_cat[$i][$prev_cat] += $current_coef[$j];                    $moy_gen_classe[$i] += $current_coef[$j]*$current_classe_matiere_moyenne[$j];                    $moy_cat_classe[$i][$prev_cat] += $current_coef[$j]*$current_classe_matiere_moyenne[$j];                    $moy_gen_eleve[$i] += $current_coef[$j]*$current_eleve_note[$j][$i];                    $moy_cat_eleve[$i][$prev_cat] += $current_coef[$j]*$current_eleve_note[$j][$i];                }            }        }        $i++;    }    $j++;}$i = 0;while ($i < $nombre_eleves) {    if ($total_coef[$i] != 0) {        $place_eleve_classe[$i] = "";        $moy_gen_eleve[$i] = $moy_gen_eleve[$i]/$total_coef[$i];        $moy_gen_classe[$i] = $moy_gen_classe[$i]/$total_coef[$i];        // Préparation des données pour affichage des graphqiues        if ($affiche_graph == 'y')  {            if ($moy_gen_eleve[$i] >= 15) {$quartile1_classe_gen++; $place_eleve_classe[$i] = 1;}            else if (($moy_gen_eleve[$i] >= 12) and ($moy_gen_eleve[$i] < 15)) {$quartile2_classe_gen++;$place_eleve_classe[$i] = 2;}            else if (($moy_gen_eleve[$i] >= 10) and ($moy_gen_eleve[$i] < 12)) {$quartile3_classe_gen++;$place_eleve_classe[$i] = 3;}            else if (($moy_gen_eleve[$i] >= 8) and ($moy_gen_eleve[$i] < 10)) {$quartile4_classe_gen++;$place_eleve_classe[$i] = 4;}            else if (($moy_gen_eleve[$i] >= 5) and ($moy_gen_eleve[$i] < 8)) {$quartile5_classe_gen++;$place_eleve_classe[$i] = 5;}            else {$quartile6_classe_gen++;$place_eleve_classe[$i] = 6;}        }        // Eric déplacé en fin de fichier dans une nouvelle boucle.        //$moy_gen_eleve[$i] = number_format($moy_gen_eleve[$i],1, ',', ' ');        $moy_gen_classe[$i] = number_format($moy_gen_classe[$i],1, ',', ' ');    } else {        $moy_gen_eleve[$i] = "-";        $moy_gen_classe[$i] = "-";    }    foreach($categories as $cat) {	    if ($total_coef_cat[$i][$cat] != 0) {	        $moy_cat_eleve[$i][$cat] = $moy_cat_eleve[$i][$cat]/$total_coef_cat[$i][$cat];	        $moy_cat_classe[$i][$cat] = $moy_cat_classe[$i][$cat]/$total_coef_cat[$i][$cat];	        $moy_cat_eleve[$i][$cat] = number_format($moy_cat_eleve[$i][$cat],1, ',', ' ');	        $moy_cat_classe[$i][$cat] = number_format($moy_cat_classe[$i][$cat],1, ',', ' ');	    } else {	        $moy_cat_eleve[$i][$cat] = "-";	        $moy_cat_classe[$i][$cat] = "-";	    }    }    $i++;}//Ajout Eric pour avoir les moyennes générales minimum et maximum sur les bulletins$moy_min_classe = min($moy_gen_eleve);$moy_min_classe = number_format($moy_min_classe,1, ',', ' ');$moy_max_classe = max($moy_gen_eleve);$moy_max_classe = number_format($moy_max_classe,1, ',', ' ');//Calcul de la moyenne  général de la classe$nb_elv_classe=sizeof($moy_gen_eleve);$moy_generale_classe = 0;for ( $i=0 ; $i < $nb_elv_classe ; $i++ ) {  $moy_generale_classe += $moy_gen_eleve[$i]; }$moy_generale_classe = $moy_generale_classe / $nb_elv_classe;$moy_generale_classe = number_format($moy_generale_classe,1, ',', ' ');for ( $i=0 ; $i < sizeof($moy_gen_eleve) ; $i++ ) {  $moy_gen_eleve[$i] = number_format($moy_gen_eleve[$i],1, ',', ' ');}?>